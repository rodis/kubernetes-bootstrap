---
- hosts: localhost
  connection: local

  tasks:       
    - name: Create ports for the master nodes
      os_port:
        cloud: "{{cloud_env}}"
        state: present
        name: "{{hostvars[item]['inventory_hostname']}}" 
        network: "{{net}}"
        fixed_ips:
          - ip_address: "{{hostvars[item]['fixed_ip']}}"
      with_items: "{{groups['all']}}"
      when:
        - "\"{{hostvars[item]['inventory_hostname']}}\" != 'localhost'"


    - name: Boot master nodes
      os_server:
        cloud: "{{cloud_env}}"
        name: "{{hostvars[item]['inventory_hostname']}}" 
        state: present
        nics:
          - port-name: "{{hostvars[item]['inventory_hostname']}}" 
        image: "{{image}}"
        flavor: "{{flavor}}"
        key_name: "{{key_name}}"
        floating_ips:
          "{{hostvars[item]['ansible_host']}}"
        security_groups: "{{security_groups}}"
        meta:
          groups: masters,etcd
      with_items: "{{groups['all']}}"
      when:
        - "\"{{hostvars[item]['inventory_hostname']}}\" == 'kube-master-1'"

    - name: Boot kube nodes
      os_server:
        cloud: "{{cloud_env}}"
        name: "{{hostvars[item]['inventory_hostname']}}" 
        state: present
        nics:
          - port-name: "{{hostvars[item]['inventory_hostname']}}" 
        image: "{{image}}"
        flavor: "{{flavor}}"
        key_name: "{{key_name}}"
        floating_ips:
          "{{hostvars[item]['ansible_host']}}"
        security_groups: "{{security_groups}}"
        meta:
          group: nodes
      with_items: "{{groups['all']}}"
      when:
        - "\"{{hostvars[item]['inventory_hostname']}}\" != 'kube-master-1'"

- hosts: all
  gather_facts: false
  tasks:
    - name: Wait until ssh is available
      command: >
        ssh
        -o BatchMode=yes
        -o UserKnownHostsFile=/dev/null
        -o StrictHostKeyChecking=no
        -i ~/.ssh/k8s.pem
        {{ansible_user}}@{{ansible_host}} true
      connection: local
      register: result
      until: result|success
      retries: 50
      delay: 5
      changed_when: False
