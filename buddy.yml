- pipeline: "Build cluster"
  trigger_mode: "MANUAL"
  ref_name: "master"
  actions:
  - action: "Bootstrap the OS cluster"
    type: "BUILD"
    docker_image_name: "alpine"
    docker_image_tag: "latest"
    execute_commands:
    - "source ./credentials"
    - >
        ansible-playbook 
        -i .kargo/inventory 
        --private-key /root/.ssh/k8s 
        -e 'masters_num=2' 
        -e 'nodes_num=3' 
        -e 'masters_flavor=m1.small' 
        -e 'nodes_flavor=m1.large' 
        -e 'image=0d69bf12-e518-43d3-b5e5-5f3369a2d572' 
        -e 'security_groups=default' up.yml
    setup_commands:
    - "apk update"
    - "apk add python2 py2-pip gcc python2-dev musl-dev libffi-dev"
    - "apk add openssl-dev ca-certificates linux-headers coreutils git"
    - "pip install -U pip"
    - "pip install -U ansible"
    - "pip install -U shade"
  - action: "Build Kubernetes"
    type: "BUILD"
    docker_image_name: "alpine"
    docker_image_tag: "latest"
    execute_commands:
    - "export OS_AUTH_URL=https://os.ch-ti1.server.one/v3"
    - "export OS_USERNAME=rods"
    - "export OS_REGION_NAME=ch-ti1"
    - "export OS_TENANT_ID=db5218670782412f95eb22be133f96c5"
    - "export OS_PASSWORD=Z8GZgUhiCksn"
    - "export OS_USER_DOMAIN_NAME=Default"
    - "rm -rf .kargo"
    - "git clone https://github.com/kubernetes-incubator/kargo .kargo"
    - "rm `ls -d -1 .kargo/inventory/* | grep -v group_vars`"
    - "cp inventory/openstack.py .kargo/inventory"
    - "cp inventory/static .kargo/inventory"
    - "chmod +x .kargo/inventory/openstack.py"
    - "cd .kargo"
    - >
        ansible-playbook
        -i inventory cluster.yml
        -e 'bootstrap_os=ubuntu'
        -e 'nginx_kube_apiserver_port=8443'
        -e 'kube_network_plugin=flannel'
        --ssh-extra-args='-o StrictHostKeyChecking=no'
        --private-key /root/.ssh/k8s
        -s
        -u ubuntu
    setup_commands:
    - "apk update"
    - "apk add python2 py2-pip gcc python2-dev musl-dev libffi-dev"
    - "apk add openssl-dev ca-certificates linux-headers coreutils git"
    - "pip install -U pip"
    - "pip install -U ansible"
    - "pip install -U shade"